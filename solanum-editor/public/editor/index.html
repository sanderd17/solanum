<html>
  <head>
    <meta charset="utf-8" />
    <title>Editor</title>
    <script src="./svgedit/jquery.min.js"></script>
    <script src="./svgedit/jquery-ui/jquery-ui-1.8.17.custom.min.js"></script>
    <style> #svgroot { overflow: hidden; } </style>
  </head>

  <body>
    <div id="root" style="position:absolute;left:0;top:0"></div>

    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>

    <!-- Editor stil refers to invisible elements, this should be part of canvas-->
    <svg id="childSvgs" style="display:none"></svg>

    <div>
      <button onclick="canvas.deleteSelectedElements()">Delete Selected</button>
      <button onclick="canvas.clear(); canvas.updateCanvas(width, height);">Clear All</button>
      <button onclick="alert(canvas.getSvgString())">Get SVG</button>
      <button onclick="saveSvg()">Save</button>
    </div>
    <ul id="componentList">

    </ul>
    <script>
      function saveSvg() {
        let name = 'Motor'
        let svgNode = document.getElementById('svgcontent')
        let svg = svgNode.outerHTML
        fetch('/API/Editor/setComponentSvg', {
          method: 'POST',
          body: JSON.stringify({
            module: window.currentModule,
            component: window.currentComponent,
            svg: svg,
            class: window.currentClass,
            width: window.currentSize[0],
            height: window.currentSize[1],
          }),
          headers:{
            'Content-Type': 'application/json'
          }
        })
      }
    </script>

    <div id="errorOverlay">
    <script type="module" src="index.js"></script>
    <script type="module">
import SvgCanvas from './svgedit/svgcanvas.js';

window.currentModule = ''
window.currentComponent = ''
window.currentSize = [300, 300]
window.currentClass = ''

fetch('../API/Editor/getComponentPaths', {cache: 'reload'})
  .then(async response => {
    const modules = await response.json()
    const ul = document.getElementById('componentList')
    for (let mod in modules) {
      let li = document.createElement('li')
      li.textContent = mod
      ul.appendChild(li)
      let components = modules[mod]
      let childUl = document.createElement('ul')
      for (let cmp of components) {
        let li = document.createElement('li')
        li.textContent = cmp
        li.onclick = async () => {
          window.currentModule = mod
          window.currentComponent = cmp
          const module = await import('/templates/' + cmp)
          /** @type {typeof Template} */
          const cmpClass = module.default
          // TODO find a better string than id, but svgedit breaks on special characters in use referals
          const inst = new cmpClass(null, 'id', true, {})
          inst.createSubTemplates()
          const parser = new DOMParser()

          inst.forEachChild(child => {
            let childDom = child.render()
            childDom.documentElement.setAttribute('id', '--' + child.id)
            document.getElementById('childSvgs').appendChild(childDom.documentElement)
          }, true)
          const svgDom = inst.render()
          //svgDom.setAttribute('version', '1.1')
          //svgDom.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
          //svgDom.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
          const viewBox = svgDom.documentElement.getAttribute('viewBox')
          const [_1, _2, w, h] = viewBox.split(' ')
          window.currentSize = [w, h]
          window.currentClass = svgDom.documentElement.getAttribute('class')
          const XmlS = new XMLSerializer()
          setTimeout(() => canvas.setSvgString(XmlS.serializeToString(svgDom), false), 0)
          canvas.setResolution(w, h)
          canvas.updateCanvas(w, h)
        }
        childUl.appendChild(li)
      }
      ul.appendChild(childUl)
    }
  })
    </script>
  </body>
</html>
