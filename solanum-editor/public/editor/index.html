<html>
  <head>
    <meta charset="utf-8" />
    <title>Editor</title>
    <script src="./svgedit/jquery.min.js"></script>
    <script src="./svgedit/jquery-ui/jquery-ui-1.8.17.custom.min.js"></script>
    <style> #svgroot { overflow: hidden; } </style>
  </head>

  <body>
    <div id="root" style="position:absolute;left:0;top:0"></div>

    <h1>Solanum editor</h1>

    <div id="editorContainer"></div>

    <div>
      <input type="color" id="fill" name="fill" value="#FF0000"/>
      <input type="color" id="stroke" name="stroke" value="#000000"/>
      <button onclick="canvas.deleteSelectedElements()">Delete Selected</button>
      <button onclick="canvas.clear(); canvas.updateCanvas(width, height);">Clear All</button>
      <button onclick="alert(canvas.getSvgString())">Get SVG</button>
      <button onclick="saveSvg()">Save</button>
    </div>
    <ul id="componentList">

    </ul>
    <script>
      function saveSvg() {
        let name = 'Motor'
        let svg = document.getElementById('svgcontent').children[0].innerHTML
        fetch('/API/Editor/setComponentSvg', {
          method: 'POST',
          body: JSON.stringify({
            module: window.currentModule,
            component: window.currentComponent,
            svg: svg
          }),
          headers:{
            'Content-Type': 'application/json'
          }
        })
      }
    </script>

    <script type="module">
import SvgCanvas from './svgedit/svgcanvas.js';

const container = document.querySelector('#editorContainer');
const {width, height} = {width: 500, height: 300};
window.width = width;
window.height = height;

const config = {
  initFill: {color: 'FFFFFF', opacity: 1},
  initStroke: {color: '000000', opacity: 1, width: 1},
  text: {stroke_width: 0, font_size: 24, font_family: 'serif'},
  initOpacity: 1,
  imgPath: 'editor/images/',
  dimensions: [width, height],
  baseUnit: 'px',
};

window.canvas = new SvgCanvas(container, config);
canvas.updateCanvas(width, height);

const updateSelectedElements = (attr, val) => canvas.getSelectedElems().forEach(el => el.setAttribute(attr, val))

document.getElementById('fill').addEventListener('input', (ev) => updateSelectedElements('fill', ev.target.value))
document.getElementById('stroke').addEventListener('input', (ev) => updateSelectedElements('stroke', ev.target.value))

window.currentModule = ''
window.currentComponent = ''

fetch('../API/Editor/getComponentPaths', {cache: 'reload'})
  .then(async response => {
    const modules = await response.json()
    const ul = document.getElementById('componentList')
    for (let mod in modules) {
      let li = document.createElement('li')
      li.textContent = mod
      ul.appendChild(li)
      let components = modules[mod]
      let childUl = document.createElement('ul')
      for (let cmp of components) {
        let li = document.createElement('li')
        li.textContent = cmp
        li.onclick = async () => {
          window.currentModule = mod
          window.currentComponent = cmp
          const module = await import('/templates/' + cmp)
          /** @type {typeof Template} */
          const cmpClass = module.default
          const [w, h] = cmpClass.prototype.size
          // TODO find a better string than id, but svgedit breaks on special characters
          const inst = new cmpClass(null, 'id', true, {width: w, height: h, x:0, y:0})
          inst.createSubTemplates()
          const svg = inst.render()
          canvas.setSvgString(svg, false)
          canvas.setResolution(w, h)
          canvas.updateCanvas(w, h)
        }
        childUl.appendChild(li)
      }
      ul.appendChild(childUl)
    }
  })
    </script>
    <div id="errorOverlay">
    <script type="module" src="index.js"></script>
  </body>
</html>
